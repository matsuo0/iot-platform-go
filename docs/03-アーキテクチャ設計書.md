# アーキテクチャ設計書

## 概要

IoT Platform Goは、クリーンアーキテクチャの原則に基づいて設計されています。各レイヤーが明確に分離され、依存関係が内側に向かう構造になっています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ HTTP API    │  │ WebSocket   │  │ MQTT Client │        │
│  │ (Gin)       │  │ Hub         │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Device      │  │ Data        │  │ Auth        │        │
│  │ Service     │  │ Service     │  │ Service     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Device      │  │ Data        │  │ User        │        │
│  │ Repository  │  │ Repository  │  │ Repository  │        │
│  │ Interface   │  │ Interface   │  │ Interface   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ PostgreSQL  │  │ InfluxDB    │  │ MQTT        │        │
│  │ Repository  │  │ Repository  │  │ Broker      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
iot-platform-go/
├── cmd/                    # アプリケーションエントリーポイント
│   ├── server/            # メインサーバー
│   └── migrate/           # データベースマイグレーション
├── internal/              # 内部パッケージ（外部からインポート不可）
│   ├── api/              # HTTPハンドラー（Presentation Layer）
│   │   ├── handlers/     # リクエストハンドラー
│   │   ├── middleware/   # ミドルウェア
│   │   └── routes/       # ルーティング設定
│   ├── config/           # 設定管理
│   ├── database/         # データベース接続
│   ├── device/           # デバイス関連ビジネスロジック
│   │   ├── service/      # アプリケーションサービス
│   │   └── repository/   # リポジトリ実装
│   ├── mqtt/             # MQTTクライアント（予定）
│   └── websocket/        # WebSocketハブ（予定）
├── pkg/                   # 外部公開パッケージ
│   ├── models/           # データモデル
│   └── utils/            # ユーティリティ関数
├── configs/              # 設定ファイル
├── docs/                 # ドキュメント
├── scripts/              # ビルド・デプロイスクリプト
└── docker-compose.yml    # Dockerサービス定義
```

## レイヤー詳細

### 1. Presentation Layer

HTTP API、WebSocket、MQTTクライアントなどの外部インターフェースを担当します。

#### HTTP API (Gin)
- **責任**: HTTPリクエストの受信・レスポンスの送信
- **依存**: Application Layer
- **実装場所**: `internal/api/`

```go
// 例: デバイスハンドラー
type DeviceHandler struct {
    deviceService *device.Service
}

func (h *DeviceHandler) CreateDevice(c *gin.Context) {
    // HTTPリクエストの処理
    // ビジネスロジックの呼び出し
    // レスポンスの生成
}
```

#### WebSocket Hub
- **責任**: リアルタイム通信の管理
- **依存**: Application Layer
- **実装場所**: `internal/websocket/`

#### MQTT Client
- **責任**: MQTTメッセージの受信・送信
- **依存**: Application Layer
- **実装場所**: `internal/mqtt/`

### 2. Application Layer

ビジネスロジックとユースケースを担当します。

#### Device Service
- **責任**: デバイス関連のビジネスロジック
- **依存**: Domain Layer
- **実装場所**: `internal/device/service/`

```go
// 例: デバイスサービス
type DeviceService struct {
    deviceRepo device.Repository
}

func (s *DeviceService) CreateDevice(ctx context.Context, req *CreateDeviceRequest) (*Device, error) {
    // ビジネスルールの適用
    // リポジトリの呼び出し
    // 結果の返却
}
```

#### Data Service
- **責任**: データ処理・分析ロジック
- **依存**: Domain Layer
- **実装場所**: `internal/data/service/`

#### Auth Service
- **責任**: 認証・認可ロジック
- **依存**: Domain Layer
- **実装場所**: `internal/auth/service/`

### 3. Domain Layer

エンティティ、リポジトリインターフェース、ドメインサービスを定義します。

#### エンティティ
- **責任**: ビジネスエンティティの定義
- **依存**: なし
- **実装場所**: `pkg/models/`

```go
// 例: デバイスエンティティ
type Device struct {
    ID        string    `json:"id" db:"id"`
    Name      string    `json:"name" db:"name"`
    Type      string    `json:"type" db:"type"`
    Location  string    `json:"location" db:"location"`
    Status    string    `json:"status" db:"status"`
    CreatedAt time.Time `json:"created_at" db:"created_at"`
    UpdatedAt time.Time `json:"updated_at" db:"updated_at"`
}
```

#### リポジトリインターフェース
- **責任**: データアクセスの抽象化
- **依存**: なし
- **実装場所**: `internal/device/repository/`

```go
// 例: デバイスリポジトリインターフェース
type Repository interface {
    Create(ctx context.Context, device *Device) error
    GetByID(ctx context.Context, id string) (*Device, error)
    GetAll(ctx context.Context) ([]*Device, error)
    Update(ctx context.Context, device *Device) error
    Delete(ctx context.Context, id string) error
}
```

### 4. Infrastructure Layer

外部システムとの接続を担当します。

#### PostgreSQL Repository
- **責任**: PostgreSQLデータベースへのアクセス
- **依存**: Domain Layer
- **実装場所**: `internal/device/repository/postgresql/`

```go
// 例: PostgreSQLリポジトリ実装
type PostgreSQLRepository struct {
    db *sql.DB
}

func (r *PostgreSQLRepository) Create(ctx context.Context, device *Device) error {
    // SQLクエリの実行
    // データベース操作
}
```

#### InfluxDB Repository
- **責任**: 時系列データの保存・取得
- **依存**: Domain Layer
- **実装場所**: `internal/data/repository/influxdb/`

#### MQTT Broker
- **責任**: MQTTメッセージのブローキング
- **依存**: なし
- **実装場所**: Dockerサービス（Mosquitto）

## 依存性注入

依存性注入を使用して、レイヤー間の結合度を下げています。

### 依存性注入の実装

```go
// main.goでの依存性注入
func main() {
    // データベース接続
    db := database.NewConnection()
    
    // リポジトリの作成
    deviceRepo := postgresql.NewDeviceRepository(db)
    
    // サービスの作成
    deviceService := device.NewService(deviceRepo)
    
    // ハンドラーの作成
    deviceHandler := api.NewDeviceHandler(deviceService)
    
    // サーバーの起動
    server := api.NewServer(deviceHandler)
    server.Run()
}
```

## データフロー

### 1. HTTPリクエストの処理フロー

```
HTTP Request → Handler → Service → Repository → Database
     ↑                                                      ↓
HTTP Response ← Handler ← Service ← Repository ← Database
```

### 2. MQTTメッセージの処理フロー

```
MQTT Message → MQTT Client → Service → Repository → Database
     ↑                                                      ↓
WebSocket Update ← WebSocket Hub ← Service ← Repository ← Database
```

## エラーハンドリング

### エラーレイヤー

1. **Infrastructure Layer**: データベースエラー、ネットワークエラー
2. **Domain Layer**: ビジネスルールエラー
3. **Application Layer**: ユースケースエラー
4. **Presentation Layer**: HTTPエラー、バリデーションエラー

### エラー処理の実装

```go
// エラーレスポンスの統一
type ErrorResponse struct {
    Code    string `json:"code"`
    Message string `json:"message"`
    Details string `json:"details,omitempty"`
}

// エラーハンドリングミドルウェア
func ErrorHandler() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        
        if len(c.Errors) > 0 {
            err := c.Errors.Last()
            // エラーレスポンスの生成
        }
    }
}
```

## 設定管理

### 設定の階層

1. **デフォルト設定**: コード内のデフォルト値
2. **環境変数**: 環境固有の設定
3. **設定ファイル**: アプリケーション設定

### 設定構造体

```go
type Config struct {
    Server   ServerConfig   `mapstructure:"server"`
    Database DatabaseConfig `mapstructure:"database"`
    MQTT     MQTTConfig     `mapstructure:"mqtt"`
    JWT      JWTConfig      `mapstructure:"jwt"`
}

type ServerConfig struct {
    Port int    `mapstructure:"port"`
    Host string `mapstructure:"host"`
}
```

## セキュリティ

### 認証・認可

- **JWT認証**: トークンベースの認証
- **RBAC**: ロールベースアクセス制御
- **API認証**: APIキー認証

### データ保護

- **暗号化**: 機密データの暗号化
- **HTTPS**: 通信の暗号化
- **入力検証**: SQLインジェクション対策

## パフォーマンス

### 最適化戦略

1. **データベース最適化**
   - インデックスの適切な設定
   - クエリの最適化
   - コネクションプール

2. **キャッシュ戦略**
   - Redisキャッシュ
   - メモリキャッシュ
   - CDNキャッシュ

3. **非同期処理**
   - メッセージキュー
   - バックグラウンドジョブ
   - イベント駆動アーキテクチャ

## 監視・ログ

### 監視項目

- **アプリケーション指標**: レスポンス時間、エラー率
- **インフラ指標**: CPU、メモリ、ディスク使用量
- **ビジネス指標**: アクティブデバイス数、データ処理量

### ログ戦略

- **構造化ログ**: JSON形式のログ
- **ログレベル**: DEBUG、INFO、WARN、ERROR
- **ログ集約**: 中央集約システム 