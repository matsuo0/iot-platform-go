# データベース設計書

## 概要

IoT Platform Goでは、PostgreSQLをメタデータ保存用、InfluxDBを時系列データ保存用として使用します。この設計書では、データベースの構造、テーブル定義、インデックス戦略について説明します。

## データベース構成

### PostgreSQL（メタデータ）

- **用途**: デバイス情報、ユーザー情報、設定情報の保存
- **バージョン**: 15+
- **文字エンコーディング**: UTF-8
- **タイムゾーン**: UTC

### InfluxDB（時系列データ）

- **用途**: センサーデータ、メトリクス、ログデータの保存
- **バージョン**: 2.0+
- **保持期間**: 1年（デフォルト）
- **圧縮**: 有効

## ER図

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     users       │    │    devices      │    │   device_data   │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ id (PK)         │    │ id (PK)         │    │ id (PK)         │
│ username        │    │ name            │    │ device_id (FK)  │
│ email           │    │ type            │    │ timestamp       │
│ password_hash   │    │ location        │    │ temperature     │
│ role            │    │ status          │    │ humidity        │
│ created_at      │    │ created_at      │    │ pressure        │
│ updated_at      │    │ updated_at      │    │ battery_level   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ device_status   │
                    ├─────────────────┤
                    │ device_id (FK)  │
                    │ status          │
                    │ last_seen       │
                    │ uptime          │
                    │ connection_quality│
                    │ battery_level   │
                    │ signal_strength │
                    └─────────────────┘
```

## PostgreSQL テーブル定義

### 1. users テーブル

ユーザー情報を管理します。

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    is_active BOOLEAN NOT NULL DEFAULT true,
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 2. devices テーブル

デバイス情報を管理します。

```sql
CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    location VARCHAR(200) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'offline',
    metadata JSONB,
    last_seen_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_devices_name ON devices(name);
CREATE INDEX idx_devices_type ON devices(type);
CREATE INDEX idx_devices_status ON devices(status);
CREATE INDEX idx_devices_location ON devices(location);
CREATE INDEX idx_devices_last_seen ON devices(last_seen_at);
CREATE INDEX idx_devices_created_at ON devices(created_at);
CREATE INDEX idx_devices_metadata ON devices USING GIN(metadata);
```

### 3. device_status テーブル

デバイスの詳細ステータス情報を管理します。

```sql
CREATE TABLE device_status (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL,
    last_seen_at TIMESTAMP WITH TIME ZONE NOT NULL,
    uptime INTERVAL,
    connection_quality VARCHAR(20),
    battery_level INTEGER CHECK (battery_level >= 0 AND battery_level <= 100),
    signal_strength INTEGER,
    firmware_version VARCHAR(50),
    ip_address INET,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_device_status_device_id ON device_status(device_id);
CREATE INDEX idx_device_status_status ON device_status(status);
CREATE INDEX idx_device_status_last_seen ON device_status(last_seen_at);
CREATE UNIQUE INDEX idx_device_status_latest ON device_status(device_id, updated_at DESC);
```

### 4. device_data テーブル

デバイスから送信されたセンサーデータを管理します（履歴データ用）。

```sql
CREATE TABLE device_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    temperature DECIMAL(5,2),
    humidity DECIMAL(5,2),
    pressure DECIMAL(8,2),
    battery_level INTEGER CHECK (battery_level >= 0 AND battery_level <= 100),
    raw_data JSONB,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_device_data_device_id ON device_data(device_id);
CREATE INDEX idx_device_data_timestamp ON device_data(timestamp);
CREATE INDEX idx_device_data_device_timestamp ON device_data(device_id, timestamp DESC);
CREATE INDEX idx_device_data_temperature ON device_data(temperature);
CREATE INDEX idx_device_data_humidity ON device_data(humidity);
```

### 5. device_alerts テーブル

デバイスアラートを管理します。

```sql
CREATE TABLE device_alerts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    alert_type VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    message TEXT NOT NULL,
    threshold_value DECIMAL(10,2),
    current_value DECIMAL(10,2),
    is_resolved BOOLEAN NOT NULL DEFAULT false,
    resolved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_device_alerts_device_id ON device_alerts(device_id);
CREATE INDEX idx_device_alerts_alert_type ON device_alerts(alert_type);
CREATE INDEX idx_device_alerts_severity ON device_alerts(severity);
CREATE INDEX idx_device_alerts_is_resolved ON device_alerts(is_resolved);
CREATE INDEX idx_device_alerts_created_at ON device_alerts(created_at);
```

### 6. api_keys テーブル

API認証用のキーを管理します。

```sql
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    key_hash VARCHAR(255) NOT NULL,
    permissions JSONB,
    is_active BOOLEAN NOT NULL DEFAULT true,
    last_used_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_key_hash ON api_keys(key_hash);
CREATE INDEX idx_api_keys_is_active ON api_keys(is_active);
CREATE INDEX idx_api_keys_expires_at ON api_keys(expires_at);
```

## InfluxDB 設計

### バケット構成

```
iot_platform/
├── sensors/          # センサーデータ
├── metrics/          # システムメトリクス
├── logs/            # アプリケーションログ
└── events/          # システムイベント
```

### センサーデータ（sensors）

#### 測定値（Measurement）

```sql
-- 温度センサーデータ
temperature,device_id=dev-001,location=living_room value=23.5,unit=celsius 1640995200000000000

-- 湿度センサーデータ
humidity,device_id=dev-001,location=living_room value=45.2,unit=percent 1640995200000000000

-- 気圧センサーデータ
pressure,device_id=dev-001,location=living_room value=1013.25,unit=hpa 1640995200000000000

-- 複合センサーデータ
sensor_data,device_id=dev-001,type=environmental,location=living_room temperature=23.5,humidity=45.2,pressure=1013.25,battery_level=85 1640995200000000000
```

#### タグ（Tags）

| タグ名 | 説明 | 例 |
|--------|------|-----|
| device_id | デバイスID | dev-001 |
| type | センサータイプ | temperature, humidity, pressure |
| location | 設置場所 | living_room, kitchen, bedroom |
| unit | 単位 | celsius, percent, hpa |

#### フィールド（Fields）

| フィールド名 | 型 | 説明 |
|-------------|----|------|
| value | float | センサー値 |
| unit | string | 単位 |
| battery_level | integer | バッテリーレベル |
| signal_strength | integer | 信号強度 |

### システムメトリクス（metrics）

```sql
-- デバイス接続数
device_connections,host=server-01 active_connections=150,total_devices=200 1640995200000000000

-- API レスポンス時間
api_response_time,endpoint=/api/devices,method=GET p50=45.2,p95=120.5,p99=250.0 1640995200000000000

-- データベース接続
database_connections,db=postgres active_connections=25,max_connections=100 1640995200000000000
```

## インデックス戦略

### PostgreSQL インデックス

#### パフォーマンス最適化

1. **複合インデックス**
```sql
-- デバイス検索の最適化
CREATE INDEX idx_devices_type_status ON devices(type, status);

-- 時系列データの最適化
CREATE INDEX idx_device_data_device_timestamp ON device_data(device_id, timestamp DESC);

-- アラート検索の最適化
CREATE INDEX idx_device_alerts_device_resolved ON device_alerts(device_id, is_resolved, created_at DESC);
```

2. **部分インデックス**
```sql
-- アクティブなデバイスのみ
CREATE INDEX idx_devices_active ON devices(id) WHERE status = 'online';

-- 未解決のアラートのみ
CREATE INDEX idx_device_alerts_unresolved ON device_alerts(id) WHERE is_resolved = false;
```

3. **GINインデックス**
```sql
-- JSONBフィールドの検索
CREATE INDEX idx_devices_metadata_gin ON devices USING GIN(metadata);

-- アラートメッセージの全文検索
CREATE INDEX idx_device_alerts_message_gin ON device_alerts USING GIN(to_tsvector('english', message));
```

### InfluxDB インデックス

#### タグインデックス

```sql
-- デバイスIDによる高速検索
-- 自動的にタグにインデックスが作成される

-- 複合タグ検索の最適化
-- device_id + location + type の組み合わせ
```

#### フィールドインデックス

```sql
-- 数値フィールドの範囲検索
-- value フィールドに対する範囲クエリの最適化
```

## データ保持戦略

### PostgreSQL

| テーブル | 保持期間 | アーカイブ戦略 |
|----------|----------|----------------|
| users | 無期限 | 削除フラグによる論理削除 |
| devices | 無期限 | 削除フラグによる論理削除 |
| device_status | 1年 | 月次アーカイブ |
| device_data | 6ヶ月 | 日次アーカイブ |
| device_alerts | 2年 | 月次アーカイブ |
| api_keys | 無期限 | 削除フラグによる論理削除 |

### InfluxDB

| バケット | 保持期間 | 圧縮戦略 |
|----------|----------|----------|
| sensors | 1年 | 1日後: 1分間隔、1週間後: 5分間隔、1ヶ月後: 1時間間隔 |
| metrics | 3ヶ月 | 1時間後: 1分間隔、1日後: 5分間隔 |
| logs | 1ヶ月 | 圧縮なし |
| events | 6ヶ月 | 1日後: 1時間間隔 |

## バックアップ戦略

### PostgreSQL

```bash
# 日次フルバックアップ
pg_dump -h localhost -U postgres -d iot_platform > backup_$(date +%Y%m%d).sql

# 継続的アーカイブ（WAL）
# postgresql.conf の設定
wal_level = replica
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'
```

### InfluxDB

```bash
# バケットのエクスポート
influx backup -b sensors /backup/sensors_$(date +%Y%m%d)

# 継続的バックアップ
# influxdb.conf の設定
[backup]
  enabled = true
  path = "/backup"
  retention = "30d"
```

## マイグレーション管理

### マイグレーションファイル

```sql
-- 001_create_users_table.sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 002_create_devices_table.sql
CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    location VARCHAR(200) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'offline',
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

### マイグレーション実行

```bash
# マイグレーションの実行
make migrate

# 特定のバージョンまでロールバック
make migrate-rollback VERSION=001

# マイグレーション状態の確認
make migrate-status
```

## パフォーマンス監視

### クエリパフォーマンス

```sql
-- スロークエリの監視
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- インデックス使用状況
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### InfluxDB パフォーマンス

```sql
-- クエリパフォーマンスの監視
SHOW STATS

-- シリーズ数の監視
SHOW SERIES CARDINALITY
```

## セキュリティ

### アクセス制御

```sql
-- ユーザー権限の設定
GRANT CONNECT ON DATABASE iot_platform TO iot_user;
GRANT USAGE ON SCHEMA public TO iot_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO iot_user;

-- 行レベルセキュリティ（RLS）
ALTER TABLE devices ENABLE ROW LEVEL SECURITY;

CREATE POLICY device_access_policy ON devices
    FOR ALL
    TO iot_user
    USING (created_by = current_user);
```

### データ暗号化

```sql
-- 機密データの暗号化
CREATE EXTENSION pgcrypto;

-- パスワードの暗号化
UPDATE users SET password_hash = crypt(password, gen_salt('bf'));
``` 