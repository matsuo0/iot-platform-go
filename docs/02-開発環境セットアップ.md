# 開発環境セットアップガイド

## 前提条件

### 必要なツール

| ツール | バージョン | インストール方法 |
|--------|------------|------------------|
| Go | 1.21+ | [golang.org/dl](https://golang.org/dl/) |
| Docker | 20.10+ | [docker.com](https://docker.com/) |
| Docker Compose | 2.0+ | Docker Desktopに含まれる |
| Git | 2.30+ | [git-scm.com](https://git-scm.com/) |
| Make | 4.0+ | macOS: `brew install make` |

### 推奨ツール

| ツール | 用途 | インストール方法 |
|--------|------|------------------|
| VS Code | エディタ | [code.visualstudio.com](https://code.visualstudio.com/) |
| GoLand | IDE | [jetbrains.com/go](https://www.jetbrains.com/go/) |
| Postman | APIテスト | [postman.com](https://postman.com/) |
| pgAdmin | PostgreSQL管理 | [pgadmin.org](https://www.pgadmin.org/) |

## セットアップ手順

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd iot-platform-go
```

### 2. 環境変数の設定

```bash
# 環境変数ファイルのコピー
cp configs/env.example .env

# 環境変数の編集
# 必要に応じて値を変更してください
```

#### 主要な環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|--------------|
| `SERVER_PORT` | サーバーポート | 8080 |
| `SERVER_HOST` | サーバーホスト | localhost |
| `DB_HOST` | データベースホスト | localhost |
| `DB_PORT` | データベースポート | 5432 |
| `DB_NAME` | データベース名 | iot_platform |
| `DB_USER` | データベースユーザー | postgres |
| `DB_PASSWORD` | データベースパスワード | password |
| `MQTT_BROKER` | MQTTブローカーURL | tcp://localhost:1883 |
| `JWT_SECRET` | JWT秘密鍵 | your-secret-key-here |

### 3. Dockerサービスの起動

```bash
# インフラサービスの起動
make docker-up

# 起動確認
docker-compose ps
```

#### 起動されるサービス

| サービス | ポート | 用途 |
|----------|--------|------|
| PostgreSQL | 5432 | メタデータ保存 |
| Mosquitto | 1883 | MQTTブローカー |
| Grafana | 3000 | 可視化（オプション） |

### 4. 依存関係のインストール

```bash
# Goモジュールのダウンロード
make deps

# または
go mod download
```

### 5. データベースの初期化

```bash
# データベースマイグレーション
make migrate

# または手動で実行
go run cmd/migrate/main.go
```

### 6. アプリケーションの起動

```bash
# 開発モードで起動
make run

# または
go run cmd/server/main.go
```

## 開発用コマンド

### 基本的なコマンド

```bash
make help          # 利用可能なコマンド一覧
make build         # アプリケーションのビルド
make run           # アプリケーションの起動
make test          # テストの実行
make clean         # ビルド成果物の削除
```

### Docker関連コマンド

```bash
make docker-up     # Dockerサービスの起動
make docker-down   # Dockerサービスの停止
make logs          # Dockerログの表示
make restart       # Dockerサービスの再起動
```

### 開発支援コマンド

```bash
make fmt           # コードフォーマット
make lint          # コードリント
make test-cover    # テストカバレッジ
make generate      # コード生成
```

## 動作確認

### 1. ヘルスチェック

```bash
curl http://localhost:8080/health
```

期待されるレスポンス:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### 2. APIテスト

```bash
# デバイスの作成
curl -X POST http://localhost:8080/api/devices \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Temperature Sensor 1",
    "type": "temperature",
    "location": "Living Room"
  }'

# デバイス一覧の取得
curl http://localhost:8080/api/devices
```

### 3. データベース接続確認

```bash
# PostgreSQLへの接続確認
docker exec -it iot-platform-go-postgres-1 psql -U postgres -d iot_platform -c "\dt"
```

## トラブルシューティング

### よくある問題

#### 1. ポートが既に使用されている

```bash
# 使用中のポートを確認
lsof -i :8080
lsof -i :5432

# プロセスの終了
kill -9 <PID>
```

#### 2. Dockerサービスが起動しない

```bash
# Dockerサービスの状態確認
docker-compose ps

# ログの確認
docker-compose logs

# サービスの再起動
docker-compose down
docker-compose up -d
```

#### 3. データベース接続エラー

```bash
# PostgreSQLの状態確認
docker exec -it iot-platform-go-postgres-1 pg_isready

# データベースの再作成
docker-compose down -v
docker-compose up -d
```

#### 4. Goモジュールエラー

```bash
# モジュールキャッシュのクリア
go clean -modcache

# 依存関係の再ダウンロード
go mod download
```

## 開発ワークフロー

### 1. 機能開発の流れ

```bash
# 1. 新しいブランチを作成
git checkout -b feature/new-feature

# 2. 開発・テスト
make run
make test

# 3. コードフォーマット・リント
make fmt
make lint

# 4. コミット
git add .
git commit -m "feat: add new feature"

# 5. プルリクエスト作成
git push origin feature/new-feature
```

### 2. テスト実行

```bash
# 全テストの実行
make test

# 特定のパッケージのテスト
go test ./internal/device -v

# テストカバレッジ
make test-cover
```

### 3. デバッグ

```bash
# デバッグモードで起動
go run -race cmd/server/main.go

# プロファイリング
go run cmd/server/main.go -cpuprofile=cpu.prof
```

## 本番環境への移行

### 1. 環境変数の設定

```bash
# 本番用環境変数
cp configs/env.production .env.production
```

### 2. セキュリティ設定

- JWT秘密鍵の変更
- データベースパスワードの強化
- HTTPS証明書の設定

### 3. パフォーマンス最適化

- データベースインデックスの最適化
- キャッシュの設定
- ロードバランサーの設定 